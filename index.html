<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Appointment Waiting Times</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Roboto', sans-serif;
    background-color: #f5f7fa;
    color: #333;
    line-height: 1.6;
    padding: 20px;
  }
  .container {
    max-width: 1000px;
    margin: 0 auto 60px auto;
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    padding: 30px;
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  h1 { font-size: 2.2rem; color: #1a3c6d; }

  #datetime {
    font-size: 1rem;
    color: #555;
    margin-top: 4px;
    font-weight: 500;
  }

  .logo { max-width: 150px; height: auto; }

  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td {
    padding: 15px;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
    vertical-align: middle;
    font-size: 1rem;
  }
  th {
    background-color: #1a3c6d;
    color: #fff;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.85rem;
  }
  tr { transition: background-color 0.18s ease; }
  tr:hover { background-color: #fbfcfe; }

  .wait-cell {
    color: #fff;
    font-weight: 600;
    text-align: center;
    border-radius: 6px;
    padding: 12px;
    min-width: 140px;
    display: inline-block;
    width: 100%;
    box-sizing: border-box;
  }
  .wait-green { background-color: #28a745; }
  .wait-lightgreen { background-color: #8bc34a; }
  .wait-yellow { background-color: #fbc02d; color: #333; } /* Improved contrast */
  .wait-red { background-color: #ff4d4d; }
  .wait-grey { background-color: #e9ecef; color: #333; }

  #loading, #error { text-align: center; margin: 20px 0; }
  #loading { font-size: 1.05rem; color: #555; }
  #error { color: #ff4d4d; font-weight: 600; display: none; }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Appointment Waiting Times</h1>
        <div id="datetime" aria-live="polite"></div>
      </div>
      <img src="logo.png" alt="Clinic Logo" class="logo" onerror="this.style.display='none'">
    </header>

    <div id="loading">Loading data...</div>
    <div id="error" role="alert"></div>

    <table id="waiting-times-table" aria-label="Appointment Waiting Times">
      <thead>
        <tr>
          <th scope="col">Doctor</th>
          <th scope="col">Status</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

<script>
  const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR6isKQeI8cgW7iaTV4KfnUugomy_4cHq-RcpqTDj1haz0uJFqIYi08khnhm5JuudGXxD4hh117g0GR/pub?output=csv';
  const cacheKey = 'waitingTimesData';
  const cacheTimeKey = 'waitingTimesCacheTime';
  const cacheDuration = 5 * 60 * 1000; // 5 minutes

  function escapeHtml(s = '') {
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  function getWaitClassAndLabel(waitRaw){
    if (waitRaw === undefined || waitRaw === null) return { cls: 'wait-grey', label: '' };
    const raw = String(waitRaw).trim();
    const s = raw.toLowerCase();
    if (s === 'on time' || s === 'ontime' || s === 'on-time') return { cls: 'wait-green', label: raw };
    if (s === '15 minute delay' || s === '15 min delay' || s === '15 min' || s === '15') return { cls: 'wait-lightgreen', label: raw };
    if (s === '30 minute delay' || s === '30 min delay' || s === '30 min' || s === '30') return { cls: 'wait-yellow', label: raw };
    if (s === 'severely delayed' || /severe/.test(s)) return { cls: 'wait-red', label: raw };
    const numMatch = raw.match(/\d+/);
    if (numMatch) {
      const n = Number(numMatch[0]);
      if (!Number.isNaN(n)) {
        if (n <= 5) return { cls: 'wait-green', label: raw };
        if (n <= 15) return { cls: 'wait-lightgreen', label: raw };
        if (n <= 30) return { cls: 'wait-yellow', label: raw };
        return { cls: 'wait-red', label: raw };
      }
    }
    return { cls: 'wait-grey', label: raw };
  }

  function saveToCache(rows) {
    try { localStorage.setItem(cacheKey, JSON.stringify(rows)); localStorage.setItem(cacheTimeKey, Date.now()); }
    catch(e) { /* ignore */ }
  }
  function loadFromCache() {
    try {
      const c = localStorage.getItem(cacheKey);
      const t = localStorage.getItem(cacheTimeKey);
      if (c && t && (Date.now() - Number(t)) < cacheDuration) return JSON.parse(c);
    } catch(e) {}
    return null;
  }

  function parseCsv(text) {
    const p = Papa.parse(text.trim(), { skipEmptyLines: true });
    return p.data || [];
  }

  async function fetchData() {
    const loading = document.getElementById('loading');
    const errorDiv = document.getElementById('error');
    const tbody = document.getElementById('table-body');
    loading.style.display = 'block';
    errorDiv.style.display = 'none';
    tbody.innerHTML = '';

    try {
      let rows = loadFromCache();
      if (!rows) {
        const resp = await fetch(csvUrl, { cache: 'no-store' });
        if (!resp.ok) throw new Error('Failed to fetch CSV (status ' + resp.status + ')');
        const text = await resp.text();
        rows = parseCsv(text);
        saveToCache(rows);
      }

      if (!Array.isArray(rows) || rows.length < 2) {
        throw new Error('CSV appears empty or has no data rows');
      }

      for (let i = 1; i < rows.length; i++) {
        const row = rows[i] || [];
        const doctor = (row[0] !== undefined ? String(row[0]).trim() : '');
        let waitRaw = '';
        if (row.length >= 3) {
          waitRaw = row[2] !== undefined ? String(row[2]).trim() : '';
        } else if (row.length === 2) {
          waitRaw = row[1] !== undefined ? String(row[1]).trim() : '';
        } else {
          continue;
        }

        if (!doctor) continue;

        const wait = getWaitClassAndLabel(waitRaw);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(doctor)}</td>
          <td><div class="wait-cell ${wait.cls}">${escapeHtml(wait.label)}</div></td>
        `;
        tbody.appendChild(tr);
      }

      loading.style.display = 'none';
    } catch (err) {
      loading.style.display = 'none';
      errorDiv.textContent = 'Error loading data: ' + err.message;
      errorDiv.style.display = 'block';
      console.error(err);
    }
  }

  function updateDateTime() {
    const now = new Date();
    const options = {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
      second: '2-digit',
    };
    const formatted = now.toLocaleString(undefined, options);
    document.getElementById('datetime').textContent = formatted;
  }

  window.addEventListener('load', () => {
    fetchData();
    setInterval(fetchData, 5 * 60 * 1000);
    updateDateTime();
    setInterval(updateDateTime, 1000);
  });
</script>
</body>
</html>
